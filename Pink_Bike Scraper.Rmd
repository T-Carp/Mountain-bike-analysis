---
title: "Pink Bike Scraper"
output: html_notebook
---


### Essential Packages
```{r}
library(tidyverse)
library(rvest)
library(xml2)
library(jsonlite)
library(ggplot2)
```

### Scrape Pink Bike, Create Data Frame
```{r}

df_list <- list()

url <- paste("https://www.pinkbike.com/buysell/list/?location=194-*-*&page=1&category=2")
page <- read_html(url)
  
### Find total results
total_count <- html_node(page, 'li:nth-child(13) a') %>% 
  html_text() %>% 
  as.numeric()
  
### Create vector of page results.  
pages <- c(1:total_count)

for (l in 1:length(pages))
{
  page_data <- paste("https://www.pinkbike.com/buysell/list/?location=194-*-*&page=",pages[l],"&category=2", sep = "") %>% read_html()
  
  title <- html_nodes(page_data, '.bsitem div a') %>% 
    html_text(trim = TRUE) 
  
  seller <- html_nodes(page_data, '.bsitem b+ a') %>% 
    html_text(trim = TRUE) 
   
  
  # condition <- html_nodes(page_data, 'br+ div') %>% 
  #   html_text(trim=TRUE) 
  
  
  # material <- html_nodes(page_data, '.bsitem div:nth-child(4)') %>% 
  #   html_text(trim=TRUE)
    
  
  # frame_size <- html_nodes(page_data, '.bsitem div:nth-child(5)') %>% 
  #   html_text(trim=TRUE) 
     
  
  # wheel_size <- html_nodes(page_data, '.bsitem div:nth-child(6)') %>% 
  #   html_text(trim=TRUE)
      
  
  # front_travel <- html_nodes(page, '.bsitem div:nth-child(7)') %>% 
  #   html_text(trim=TRUE) %>% 
  #   if(length(.) == 0) NA else .
       
  
  # rear_travel <- html_nodes(page_data, '.bsitem div:nth-child(8)') %>% 
  #   html_text(trim=TRUE)

  
  location <- html_nodes(page_data, '.bsitem td tr:nth-child(1) td') %>% 
    html_text(trim=TRUE) 
        
  
  price <- html_nodes(page_data, 'tr~ tr+ tr td > b') %>% 
    html_text(trim=TRUE)  
  
  df_list[[l]] <- data_frame(title, seller, location, price )
}

df <- as_tibble(bind_rows(df_list)) 


p <- ggplot(df, aes(x=price)) + 
  geom_histogram()
```



### Data Prep
```{r}
### Extract year from string
library(stringr)

### Remove duplicate posts
df<- distinct(df)

### Clean price column
df$price <- str_remove(df$price,"USD")
df$price <- as.integer(str_remove(df$price,"\\$"))

### Filter out outliers
df <- df %>% 
  filter(price > 500 & price < 10000) 

### Create date columns
df <- df %>% 
  mutate(year = str_extract(df$title, "\\d{4}"),
         title = str_remove(df$title,"\\d{4}"))

### Prep for string
df$title <- str_replace_all(df$title, "Santa Cruz", "Santa_Cruz")
df$title <- str_replace_all(df$title, "SANTA CRUZ", "Santa_Cruz")
df$title <- str_replace_all(df$title, "Rocky Mountain", "Rocky_Mountain")

df <- df %>% 
  mutate(title  = trimws(title))

### Create model and brand columns
df <- df %>% 
  mutate(brand = trimws(word(df$title,1,1,)),
         model = trimws(word(df$title,2,2,)),
         year = as.numeric(year)
         ) %>% 
  separate(location,c("city", "state", "country"), sep = ",", remove = FALSE)

 

```


### Built Cross tab of Bike brands by Value and Year
```{r}
names <- df %>% 
  select(brand) %>% 
  group_by(brand) %>% 
  summarize(count = n()) %>% 
  filter(count >= 30, brand != c("Large", "Custom", "Stumpjumper"))


df_price <- df %>% 
  select(brand,price, year) %>% 
  filter(year >= 2013, brand %in% names$brand) %>% 
  group_by(brand,year) %>% 
  summarise(count = n(),avg_price = round(mean(price)))%>% 
  arrange(desc(year), .by_group = TRUE) %>% 
  mutate(pct_change = round((avg_price/lag(avg_price) - 1) * 100),
         pct_depreciation = round(avg_price/max(avg_price) * 100))

df_price$pct_change[is.na(df_price$pct_change)] <- 100


   
  

q <- ggplot(df_price, aes(reorder(year, desc(year)),avg_price)+geom_line()
q

selection <- unique(df_price$brand)

q <- ggplot() +
  geom_line(data = df_price %>% filter(brand %in% selection), aes(x = reorder(year, desc(year)), y = pct_depreciation, color = brand, group = brand), size = 1)+
  xlab("Model Year") +
  ylab("Percent of Original Value")



```

### Shiny UI
```{r}
library(shiny)
ui <- fluidPage(

  # App title ----
  titlePanel("Hello Shiny!"),

  # Sidebar layout with input and output definitions ----
  sidebarLayout(

    # Sidebar panel for inputs ----
    sidebarPanel(

      # Input: Slider for the number of bins ----
      checkboxGroupInput("checkGroup", 
                              h3("Checkbox group"), 
                              choices = unique(df_price$brand),
                              selected = 1)

    ),

    # Main panel for displaying outputs ----
    mainPanel(

      # Output: Histogram ----
      plotOutput(outputId = "distPlot")

    )
  )
)

```
### Server Script
```{r}
server <- function(input, output) {

  # Histogram of the Old Faithful Geyser Data ----
  # with requested number of bins
  # This expression that generates a histogram is wrapped in a call
  # to renderPlot to indicate that:
  #
  # 1. It is "reactive" and therefore should be automatically
  #    re-executed when inputs (input$bins) change
  # 2. Its output type is a plot
  output$distPlot <- renderPlot({

    x    <- ggplot() +
  geom_line(data = df_price %>% filter(brand %in% selection), 
            aes(x = reorder(year, desc(year)), 
                y = pct_depreciation, 
                color = brand, 
                group = brand), size = 1)+
  xlab("Model Year") +
  ylab("Percent of Original Value")
    
    })

}
```

```{r}
shinyApp(ui, server)


```

